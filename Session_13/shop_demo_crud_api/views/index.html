<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <title>Shop_Demo CRUD</title>
    <style>
        body { padding: 2rem; }

        .thumb { width: 120px; height: 80px; object-fit: cover; border-radius: 6px;}
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mb-4"> Demo CRUD (Node.js Sequelize Multer)</h1>

        <div class="card mb-4">
            <div class="card-body">
                <form action=" " id="productForm" enctype="multipart/form-data">
                    <input type="hidden" id="productId" value="">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input type="text" placeholder="Tên sản phẩm" required id="name">
                        </div>
                        <div class="col-md-2">
                            <input type="number" placeholder="Giá sản phẩm" required id="price" step="0.01" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="description" placeholder="Mô tả">
                        </div>
                        <div class="col-md-2">
                            <input type="file" class="form-control" id="image" accept="image/">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary" id="submitBtn">Thêm</button>
                        <button type="submit" class="btn btn-secondary" id="resetBtn">Reset</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="productsList" class="row gy-3"></div>
    </div>
    
</body>
<script>
    const apiBase = '/api/products'

    fetchProducts =  async () => {
        const res = await fetch(apiBase)
        const data = await res.json() 
        if(!data.success) {
            return alert('Lỗi khi tải danh sách')
        }

        const container = document.getElementById('productsList')
        container.innerHTML = ''
        data.products.forEach(product => {
            const card = document.createElement('div')

            card.className = 'col-md-4'
            card.innerHTML = `
                <div class="card h-100">
                ${product.image ? `<img src="/uploads/${product.image}" class="card-img-top thumb" alt="${product.name}">` : ''}
                    <div class="card-body">
                        <h1>Trương Hiển</h1>
                        <h5 class="card-title">${product.name}</h5>
                        <p class="card-text">${product.description || ''}</p>
                        <p class="fw-bold">${product.price?.toLocaleString()} đ</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-warning" onclick="editProduct(${product.id})">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">Xóa</button>
                        </div>
                    </div>
                </div>`;
            container.appendChild(card)
        })
    }

    deleteProduct = async (id) => {
        if(!confirm('Xác nhận xoá?')){
            return;
        }

        const res = await fetch(`${apiBase}/${id}`, {method: 'Delete'})
        const data = await res.json()

        if(data.success) {
            fetchProducts()
        }
    }

    editProduct = async (id) => {
        const res = await fetch(`${apiBase}/${id}`)
        const req = await res.json()

        if(!req.success) {
            return alert('không tìm thấy')
        } 

        const p = req.product

        document.getElementById('productId').value = p.id
        document.getElementById('name').value = p.name
        document.getElementById('price').value = p.price
        document.getElementById('description').value = p.description
        document.getElementById('submitBtn').textContent = 'Cập nhập'
    }

    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('productId').value;
        const form = new FormData();
        form.append('name', document.getElementById('name').value);
        form.append('price', document.getElementById('price').value);
        form.append('description', document.getElementById('description').value);
        const fileInput = document.getElementById('image');
        if (fileInput.files.length) form.append('image', fileInput.files[0]);

        const opts = {
        method: id ? 'PUT' : 'POST',
        body: form
        };

        const url = id ? `${apiBase}/${id}` : apiBase;
        const res = await fetch(url, opts);
        const data = await res.json();

        if (!data.success) return alert('Lỗi: ' + (data.message || 'unknown'));
        alert('Thành công');

        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('submitBtn').textContent = 'Thêm';
        fetchProducts();
    })

    fetchProducts();

</script>
</html>